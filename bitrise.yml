format_version: "9"
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

app:
  envs:
  - SAMPLE_APP_URL: https://github.com/bitrise-samples/sample-apps-xamarin-cross-platform.git
  - BITRISE_PROJECT_PATH: Multiplatform.sln
  - BITRISE_XAMARIN_CONFIGURATION: Release
  - BITRISE_XAMARIN_PLATFORM: iPhone

workflows:
  # ----------------------------------------------------------------
  # --- workflow to Step Test
  ci:
    before_run:
    - audit-this-step
    after_run:
    - test_ios
    - test_android_custom_options
    - test_macos
    steps:
    - go-list:
    - golint:
    - errcheck:
    - go-test:
    - script:
        title: Cleanup _tmp dir
        inputs:
        - content: |-
            #!/bin/bash
            set -e
            set -v
            rm -rf ./_tmp
    - change-workdir:
        title: Switch working dir to _tmp
        run_if: true
        inputs:
        - path: ./_tmp
        - is_create_path: true
    - script:
        inputs:
        - content: git clone $SAMPLE_APP_URL .
    - certificate-and-profile-installer:
        title: Install Code Sign files
    - nuget-restore:
        title: Nuget restore

  test_ios:
    after_run:
    - print_outputs
    steps:
    - path::./:
        title: Step test - ios
        inputs:
        - build_tool: msbuild
        - project_type_whitelist: ios
    - script:
        title: Check output Env. variables - iOS
        inputs:
        - content: |-
            #!/bin/bash
            set -e
            set -v
            if [[ ! -e $BITRISE_XCARCHIVE_PATH ]]; then exit 1; fi
            if [[ ! -e $BITRISE_IPA_PATH ]]; then exit 1; fi
            if [[ ! -e $BITRISE_DSYM_PATH ]]; then exit 1; fi
            if [[ ! -e $BITRISE_APP_PATH ]]; then exit 1; fi

  test_android_custom_options:
    after_run:
    - print_outputs
    steps:
    - path::./:
        title: Step test - android custom options
        inputs:
        - project_type_whitelist: android
        - ios_build_command_custom_options: /nologo
    - script:
        title: Check output Env. variables - Android
        inputs:
        - content: |-
            #!/bin/bash
            set -e
            set -v
            if [[ ! -e $BITRISE_APK_PATH ]]; then exit 1; fi

  test_macos:
    after_run:
    - print_outputs
    steps:
    - path::./:
        title: Step test - macos
        inputs:
        - project_type_whitelist: macos
        - xamarin_platform: Any CPU
    - script:
        title: Check output Env. variables - MacOS
        inputs:
        - content: |-
            #!/bin/bash
            set -e
            set -v
            if [[ ! -e $BITRISE_MACOS_APP_PATH ]]; then exit 1; fi
            if [[ ! -e $BITRISE_MACOS_PKG_PATH ]]; then exit 1; fi

  print_outputs:
    steps:
    - script:
        title: Output test
        is_always_run: true
        inputs:
        - content: |-
            echo "BITRISE_APK_PATH: $BITRISE_APK_PATH"
            echo
            echo "BITRISE_XCARCHIVE_PATH: $BITRISE_XCARCHIVE_PATH"
            echo "BITRISE_IPA_PATH: $BITRISE_IPA_PATH"
            echo "BITRISE_DSYM_PATH: $BITRISE_DSYM_PATH"
            echo "BITRISE_APP_PATH: $BITRISE_APP_PATH"
            echo
            echo "BITRISE_TVOS_XCARCHIVE_PATH: $BITRISE_TVOS_XCARCHIVE_PATH"
            echo "BITRISE_TVOS_IPA_PATH: $BITRISE_TVOS_IPA_PATH"
            echo "BITRISE_TVOS_DSYM_PATH: $BITRISE_TVOS_DSYM_PATH"
            echo "BITRISE_TVOS_APP_PATH: $BITRISE_TVOS_APP_PATH"
            echo
            echo "BITRISE_MACOS_XCARCHIVE_PATH: $BITRISE_MACOS_XCARCHIVE_PATH"
            echo "BITRISE_MACOS_APP_PATH: $BITRISE_MACOS_APP_PATH"
            echo "BITRISE_MACOS_PKG_PATH: $BITRISE_MACOS_PKG_PATH"

            envman add --key BITRISE_APK_PATH --value ""

            envman add --key BITRISE_XCARCHIVE_PATH --value ""
            envman add --key BITRISE_IPA_PATH --value ""
            envman add --key BITRISE_DSYM_PATH --value ""
            envman add --key BITRISE_APP_PATH --value ""

            envman add --key BITRISE_TVOS_XCARCHIVE_PATH --value ""
            envman add --key BITRISE_TVOS_IPA_PATH --value ""
            envman add --key BITRISE_TVOS_DSYM_PATH --value ""
            envman add --key BITRISE_TVOS_APP_PATH --value ""

            envman add --key BITRISE_MACOS_XCARCHIVE_PATH --value ""
            envman add --key BITRISE_MACOS_APP_PATH --value ""
            envman add --key BITRISE_MACOS_PKG_PATH --value ""

  # ----------------------------------------------------------------
  # --- Utility workflows
  godeps-update:
    title: Godeps update
    steps:
    - script:
        title: Dependency update
        inputs:
        - content: |
            #!/bin/bash
            set -ex
            go get -u -v github.com/tools/godep

            rm -rf ./Godeps
            rm -rf ./vendor

            go get -t -d ./...
            godep save ./...

  # ----------------------------------------------------------------
  # --- workflow to Share this step into a Step Library
  audit-this-step:
    title: Audit the Step
    steps:
    - script:
        inputs:
        - content: |-
            #!/bin/bash
            set -ex
            stepman audit --step-yml ./step.yml
